<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–ß–∞—Ç-–±–æ—Ç –†–ñ–î</title>
    <link
      rel="icon"
      href="{{ url_for('static', path='favicon.ico') }}"
      type="image/x-icon"
    />
    <link rel="stylesheet" href="{{ url_for('static', path='styles.css') }}" />
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ marked.js –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>–ß–∞—Ç-–±–æ—Ç —Å–æ—Ü–ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</h1>
        <img src="{{ url_for('static', path='Logo.svg') }}" alt="–†–ñ–î" />
      </div>
      <h2>–í–≤–µ–¥–∏—Ç–µ 0 —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å.</h2>
      <div id="chat"></div>

      <div id="input-area">
        <input
          type="text"
          id="user-input"
          placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
          onkeydown="if(event.key === 'Enter') sendMessage()"
        />
        <button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </div>

    <script>
      function sendMessage() {
        const input = document.getElementById("user-input");
        const message = input.value;

        if (message.trim() === "") return;

        const chat = document.getElementById("chat");

        // –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const userMessage = document.createElement("div");
        userMessage.classList.add("message", "user");
        userMessage.innerHTML = `<div class="bubble">${escapeHtml(
          message
        )}</div>`;
        chat.appendChild(userMessage);

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ FastAPI
        fetch("/chat", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ message: message }),
        })
          .then((response) => response.json())
          .then((data) => {
            // –°–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç–∞ —Å —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–æ–º Markdown
            const botMessage = document.createElement("div");
            botMessage.classList.add("message", "bot");

            // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ Markdown —Å –ø–æ–º–æ—â—å—é marked.js
            const htmlContent = marked.parse(data.response);

            botMessage.innerHTML = `<div class="bubble">üöÇ ${htmlContent}</div>`;
            chat.appendChild(botMessage);

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä–æ–ª–ª–∏–º –≤–Ω–∏–∑
            chat.scrollTop = chat.scrollHeight;
          })
          .catch((error) => console.error("–û—à–∏–±–∫–∞:", error));

        input.value = ""; // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
      }

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è HTML, —á—Ç–æ–±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å XSS
      function escapeHtml(text) {
        const map = {
          "&": "&amp;",
          "<": "&lt;",
          ">": "&gt;",
          '"': "&quot;",
          "'": "&#039;",
        };
        return text.replace(/[&<>"']/g, function (m) {
          return map[m];
        });
      }
    </script>
  </body>
</html>
